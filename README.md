# To Heart Converter

1997 年に [Leaf](https://ja.wikipedia.org/wiki/Leaf) から発売されたリーフ[ビジュアルノベル](https://ja.wikipedia.org/wiki/%E3%83%93%E3%82%B8%E3%83%A5%E3%82%A2%E3%83%AB%E3%83%8E%E3%83%99%E3%83%AB)シリーズ第 3 作『[To Heart](https://ja.wikipedia.org/wiki/To_Heart)』
の画像を、透過 PNG に変換するコンバータです。

TypeScript で実装しました。

## 何のために使うもの？

『To Heart』は 18 禁ゲームであり、ゲーム画像そのものが重要なネタバレを含みます。

画像はゲームディスク内（あるいは、インストール先のディレクトリ内）に置かれていますが、Leaf 独自の圧縮形式(`.LF2`)になっています。

さらに、複数の `.LF2` を束ねた Leaf 独自のアーカイブ形式(`.PAK`)になっています。

つまり、一般的な画像ビューアで閲覧するには、

- `.PAK` を展開し、`.LF2` を生成すること
- その `.LF2` を、透過情報ごと保存可能な画像形式（`.PNG` など）に変換すること

の両方が必要です。

本ツールは、これらを実行します。

## 作ったキッカケ

同じ目的のツールは、過去にも多く存在しました。

ほとんどのサイトは、更新を停止、もしくは閉鎖されています。

それらにアップロードされているバイナリは、ビルド後の実行ファイル形式がほとんどです。

画像ビューア「[Susie](https://www.digitalpad.co.jp/~takechin/) 」用のプラグインとしても、公開されています。
これも C 言語からビルドされた DLL 形式であり、バイナリだけの公開です。

そんな中、[OS/2](https://ja.wikipedia.org/wiki/OS/2) で動作する CLI として開発された版があり、これは変換ロジックのソースコード（C 言語）が公開されていました。

## Why TypeScript ?

『To Heart』の生まれた時代に存在しない言語である TypeScript、同じく存在しないサービスである GitHub。

それらを『To Heart』と出会わせたかったためです。

解析に利用するエディタは、かつて存在しなかった Visual Studio Code です。

さらに、当時高嶺の花だった [PNG](https://tools.ietf.org/html/rfc2083)-32 形式に、無劣化で保存するという点も、大事です。

『To Heart』は劣化しないものです。

ほか、過去の有志の技術がロストテクノロジーにならないよう、未来に保存しておくためでもあります。

私は GitHub の Arctic Code Vault Contributor なので、『To Heart』という言葉が北極圏に保存されることでしょう。

## Why "To Heart" ?

レジェンドだから。

同じくレジェンドである『痕』でも良かったけれど、明るいゲームが良いだろうと。

`.LF2` 形式はすでに現役を離れた旧フォーマットであり、（営利目的でない限り）Leaf が解析情報の公開を許可している点も大きいです。

## 必要なもの

Node.js の実行環境が必要です。

もちろん、入力ファイルである `LVNS3DAT.PAK` も。

## ぜひ自分でも実装してみてください

プログラミングの練習課題として最適です。

成果が、HMX-12 の画像など、見える形で得られます。

リビドー駆動開発のサンプルとしてお使いください。

# 解説

以下、実装する方に向けて、手順を案内します。

## 『To Heart』を入手する

『To Heart』には多くのバージョンが存在します。

- オリジナルの PC 版
- PS 版、PS2 版、PSP 版などコンシューマ向け
- コンシューマ向けを PC に逆移植した PSE 版
- Windows XP に対応させたリニューアルパッケージ版

このリポジトリは、オリジナルの PC 版でのみ動作確認済みです。

まずは、日本の家庭ならどこにでもある、オリジナル版の『To Heart』を入手しましょう。

## `LVNS3DAT.PAK`、`LVNS3SCN.PAK` を取り出す

オリジナル版の『To Heart』は、公式には Windows 98 までしか動作確認されていませんが、
Windows 10 でも遊ぶことが可能です。

ゲームディスクを読み込ませます。
（DVD でなく CD）

オリジナル版では、ディスク内に `.PAK` ファイルが直接入っています。

インストーラでインストールした場合、展開された先（デフォルトでは `C:\LEAF\LVNS3`）にも同じ `.PAK` ファイルが入ります。

- LVNS3DAT.PAK
- LVNS3SCN.PAK

を、適当なディレクトリに取り出しておきましょう。

## `.PAK` をパースする

`.PAK` は、アーカイブ形式を示すために広く使われている拡張子です。

ただし、複数の OS ベンダ、ゲームメーカーがたまたま同じ拡張子を付けただけであり、実装はバラバラです。

『To Heart』の `.PAK` 形式も、Leaf 独自のものです。

パースするには、まずこの `.PAK` の仕様を知らなければなりません。

## `.PAK` の構造

バイナリとして閲覧するには、VSCode に Microsoft 純正の拡張機能「Hex Editor」をインストールします。

`.PAK` ファイルを VSCode で開いた後、`Ctrl+Shift+P` から `HexEditor: Open file` を実行します。

以下のような構造になっています。

### マジックバイト

0 バイト 目から 7 バイト 目までの計 8 バイト。

`4C 45 41 46 50 41 43 4B`

「LEAFPACK」

9 バイト目は終端文字
「先頭から読んでいき、初めて終端文字(`\0`)が現れた箇所までがマジックバイト」
という仕様だと考えられます。

C 言語ならば、文字列に変換する時に `\0` は便利ですが、
TypeScript だとあまり関係ありません。

見かけ上は半角スペースと区別付きませんが、
`.trim()` で消えないので、`.replace(/\0/, "")` が必要なことに注意。

### アーカイブ内に含まれるファイルの総数

9 バイト 目から 10 バイト 目までの計 2 バイト。

LVNS3DAT.PAK の場合、`48 02`
LVNS3SCN.PAK の場合、`E1 03`

LVNS3DAT.PAK の場合、ファイル数は 0x0248 (584)個
LVNS3SCN.PAK の場合、ファイル数は 0x03E1 (993)個

という意味です。

### ヘッダ情報

「ヘッダの開始位置は、先頭から何バイト目か？」という情報がありません。

ファイル末尾側に詰まっています。

そのほうがメリットがあったのでしょう。

tar や LZH にはそんな仕様はない
ZIP のセントラルディレクトリと似ている？

### ヘッダ情報の開始位置を調べる

LVNS3DAT.PAK の場合、0256632F
LVNS3SCN.PAK の場合、0011918A

どうやって計算するかというと、
1 ファイルあたり 24 バイト。
それがファイル数ぶん
14,016 バイト。

バッファの要素数は、25699ef(39,229,935)
39,229,935 - 14,016 = 39,215,919

39,215,919 を 16 進数にすると、0256632F

ほとんどお尻。

VSCode の Hex のスクリーンショット

### header 情報をパースする

暗号化されています。

そのまま読み出しても、化けたバイト列しか得られません。

換字式暗号
　多表式換字
　　周期換字

まず、展開に必要な鍵を探す必要があります。

鍵は計 11 バイトの数値であり、PAK 内の複数箇所にルールに従って加工された形で埋め込まれています。

位置は、以下のようになっています。

### 展開処理のロジック

ファイル名の情報は 12Byte
ファイル位置の情報は 4Byte
ファイルの長さの情報は 4Byte
次のファイル位置の情報は 4Byte

### content 情報

ヘッダ情報と同じく、暗号化されています。

展開に必要な鍵は共通なので、使い回します。

##

C 言語だと先にメモリを確保してから詰める。
そのためには総数を先に知る必要があるため、情報に含まれている。
TypeScript だと push できるので、総数は知らなくてもいい
確かめ算に使うだけ。

LVNS3SCN.PAK は 1.12 MB
LVNS3SCN は 1.09 MB

PAK 形式だと KByte
展開された全ファイルの合計は KByte

階層構造は持てないのかもしれない
UNIX 系のファイル属性も持てないので
Leaf は Windows 用限定として作ったのだと思う

ToHeart.exe は鍵を知っているから PAK を展開できる
exe のソースコードにハードコーディングされているはず。

LF2 形式だと KByte
BMP 形式だと KByte
JPG 形式だと KByte
PNG 形式だと KByte

## `.LF2` をパースする

『痕』は `.LFG` 形式

## `.LF2` の構造

以下のような構造になっています。

一切圧縮でも作れるはず
